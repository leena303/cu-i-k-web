<div class="admin-layout">

  <div class="content">
    <div class="content-header">Quản lý sản phẩm</div>
    <div class="content-body">
      <!-- PHẦN TÌM KIẾM -->
      <div style="margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center;">
        <input type="text" [(ngModel)]="searchText" placeholder="Tìm kiếm sản phẩm..."
          style="padding: 8px 14px; border-radius: 6px; border: 1px solid #334155; width: 260px;" />
        <!-- Nút thêm sản phẩm sẽ nằm bên phải -->
        <button class="btn btn-add" (click)="addProduct()">+ Thêm sản phẩm</button>
      </div>
      <!-- KẾT THÚC PHẦN TÌM KIẾM -->
      <!-- PHẦN FORM SỬA/THÊM SẢN PHẨM -->
      <div *ngIf="editMode && editingProduct" class="form-edit-product"
        style="background: black; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
        <h3>{{ editingProduct.id ? 'Sửa sản phẩm' : 'Thêm sản phẩm' }}</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
          <label style="flex: 1 1 200px;">
            Tên sản phẩm:
            <input [(ngModel)]="editingProduct.name" />
          </label>
          <label style="flex: 1 1 120px;">
            Giá:
            <input [(ngModel)]="editingProduct.price" type="number" />
          </label>
          <label style="flex: 1 1 150px;">
            Danh mục:
            <select [(ngModel)]="editingProduct.category">
              <option *ngFor="let c of categories" [value]="c.name">{{ c.name }}</option>
            </select>
          </label>
          <label style="flex: 1 1 120px;">
            Hãng:
            <input [(ngModel)]="editingProduct.trademark" />
          </label>
          <label style="flex: 1 1 120px;">
            Trạng thái:
            <select [(ngModel)]="editingProduct.status">
              <option value="Còn hàng">Còn hàng</option>
              <option value="Hết hàng">Hết hàng</option>
            </select>
          </label>
          <label style="flex: 1 1 100%;">
            Mô tả:
            <textarea [(ngModel)]="editingProduct.description" rows="2" style="width: 100%; height: 160px;"></textarea>
          </label>
          <label style="flex: 1 1 120px;">
            Số lượng:
            <input [(ngModel)]="editingProduct.quantity" type="number" min="0" />
          </label>
          <label style="flex: 1 1 180px;">
            Ảnh đại diện:
            <input type="file" #fileInput style="display:none" (change)="onFileSelected($event)" accept=".jpg,.jpeg,.png,.webp,.gif" />
            <div style="position:relative;display:inline-block;">
              <img [src]="editingProduct.image"
                style="width: 100px; height: 100px; object-fit: cover; border: 1px solid #ccc; cursor: pointer;" />
            </div>
          </label>
          <label style="flex: 1 1 180px;">
            Ảnh chi tiết:
            <input type="file" #multiFileInput multiple style="display:none" (change)="onMultiFileSelected($event)" multiple accept =".jpg,.jpeg,.png,.webp,.gif" />
            <button type="button" (click)="multiFileInput.click()">Chọn nhiều ảnh</button>
            <div style="display:flex;gap:4px;margin-top:4px;">
              <ng-container *ngFor="let img of editingProduct.images; let i = index">
                <div style="position:relative;display:inline-block;">
                  <img [src]="img" style="width:40px;height:40px;object-fit:cover;border:1px solid #ccc;">
                  <button type="button" (click)="removeDetailImage(i)"
                    style="position:absolute;top:0;right:0;background:red;color:white;border:none;border-radius:50%;width:18px;height:18px;line-height:16px;padding:0;cursor:pointer;">×</button>
                </div>
              </ng-container>
            </div>
          </label>
        </div>
        <div style="margin-top: 10px;">
          <button class="btn btn-save" type="button" (click)="saveEdit()">Lưu</button>
          <button class="btn btn-cancel" type="button" (click)="cancelEdit()">Hủy</button>
        </div>
      </div>
      <!-- KẾT THÚC PHẦN FORM -->

      <!-- PHẦN BẢNG SẢN PHẨM -->
      <table class="product-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Hình ảnh</th>
            <th>Tên sản phẩm</th>
            <th>Giá</th>
            <th>Danh mục</th>
            <th>Trạng thái</th>
            <th>Hãng</th>
            <th>Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of pagedProducts">
            <td>{{ product.id }}</td>
            <td>
              <img [src]="product.image" alt="{{product.name}}"
                style="width: 50px; height: 50px; border-radius: 4px; object-fit: cover;"
                (error)="product.image = ''" />
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.price | number }} VNĐ</td>
            <td>{{ product.category }}</td>
            <td>{{ product.status }}</td>
            <td>{{ product.trademark }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-view" (click)="viewDetail(product)">Xem chi tiết</button>
                <button class="btn btn-edit" (click)="editProduct(product.id)">Sửa</button>
                <button class="btn btn-delete" (click)="deleteProduct(product.id)">Xóa</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- KẾT THÚC PHẦN BẢNG -->

      <!-- PHẦN PHÂN TRANG -->
      <div style="margin: 16px 0; text-align: center;">
        <button class="pagination-btn" (click)="page = page - 1" [disabled]="page === 1">Trước</button>
        <span style="margin: 0 12px;">Trang {{page}} / {{totalPages}}</span>
        <button class="pagination-btn" (click)="page = page + 1" [disabled]="page === totalPages">Sau</button>
      </div>
      <!-- KẾT THÚC PHÂN TRANG -->

      <!-- PHẦN MODAL XEM CHI TIẾT -->
      <div class="modal-detail" *ngIf="viewingProduct" (click)="closeDetail()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <h2>Chi tiết sản phẩm</h2>
          <div class="modal-body">
            <img [src]="viewingProduct.image" alt="Ảnh sản phẩm" class="modal-img" />
            <div style="display:flex;gap:4px;margin:8px 0;">
              <img *ngFor="let img of viewingProduct.images" [src]="img"
                style="width:60px;height:60px;object-fit:cover;border:1px solid #ccc;">
            </div>
            <div class="modal-info">
              <p><b>Tên:</b> {{ viewingProduct.name }}</p>
              <p><b>Giá:</b> {{ viewingProduct.price | number }} VNĐ</p>
              <p><b>Danh mục:</b> {{ viewingProduct.category }}</p>
              <p><b>Hãng:</b> {{ viewingProduct.trademark }}</p>
              <p><b>Trạng thái:</b> {{ viewingProduct.status }}</p>
              <p><b>Số lượng:</b> {{ viewingProduct.quantity }}</p>
              <p class="description"><b>Mô tả:</b> {{ viewingProduct.description }}</p>
            </div>

          </div>
          <!-- KẾT THÚC MODAL XEM CHI TIẾT -->

        </div>
      </div>
    </div>